# .zshrc

{{ if .work -}}
###########################################################
# Direnv Settings                                         #
###########################################################
# Initialize direnv before atuin to avoid PROMPT_COMMAND conflicts
# and carefully to maintain compatability with p10k instant prompt.
# See https://github.com/romkatv/powerlevel10k?tab=readme-ov-file#how-do-i-initialize-direnv-when-using-instant-prompt
[ "$(command -v direnv)" ] && (( ${+commands[direnv]} )) && emulate zsh -c"$(direnv export zsh)"
{{- end -}}

###########################################################
# PROMPT SETTINGS                                         #
###########################################################

###########################################################
# VS Code and Cursor Prompt Settings                      #
# ------------------------------------------------------- #
# User a simpler prompt for VS Code and Cursor to avoid   #
# confusing the agent.                                    #
# If future config should change for JetBrains IDEs,      #
# add a check like:                                       #
#     "$TERMINAL_EMULATOR" = "JetBrains-JediTerm" || ...  #
###########################################################
export AGENT_FRIENDLY_PROMPT=false
if [[ "$TERM_PROGRAM" = "vscode" || "$TERM_PROGRAM" = "cursor" ]]; then
  AGENT_FRIENDLY_PROMPT=true
  export ZSH_THEME=''
  export PROMPT='%n@%m:%~%# '
  export RPROMPT=''

###########################################################
# Enable Powerlevel10k instant prompt.                    #
# ------------------------------------------------------- #
# Should stay close to the top of .zshrc.                 #
# Initialization code that may require console input      #
# (password prompts, [y/n] confirmations, etc.) must go   #
# above this block; everything else may go below.         #
###########################################################
elif [[ -r "${XDG_CACHE_HOME:-$HOME/.cache}/p10k-instant-prompt-${(%):-%n}.zsh" ]]; then
  source "${XDG_CACHE_HOME:-$HOME/.cache}/p10k-instant-prompt-${(%):-%n}.zsh"
fi

{{ if .work -}}
# Finish initializing direnv for p10k instant prompt compatibility
[ "$(command -v direnv)" ] && (( ${+commands[direnv]} )) && emulate zsh -c "$(direnv hook zsh)"
{{- end -}}

########################################################
# Ensure XDG_* variables are set and directories exist #
########################################################
xdg_dirs=(
  "${XDG_CONFIG_HOME}"
  "${XDG_BIN_HOME}"
  "${XDG_DATA_HOME}"
  "${XDG_STATE_HOME}"
  "${XDG_CACHE_HOME}"
  "${XDG_RUNTIME_DIR}"
)
for dir in "${xdg_dirs[@]}"; do
  [ -n "${dir}" ] && mkdir -p "${dir}"
done

# Ensure ZSH state directory exists
[ -n "${XDG_STATE_HOME}/zsh" ] && mkdir -p "${XDG_STATE_HOME}/zsh"

########################################################################
# ENV SETTINGS                                                         #
# -------------------------------------------------------------------- #
# Note: EDITOR/VISUAL, ZDOTDIR, and XDG_* variables are set in .zshenv #
########################################################################

# App-specific vars

# ansible
export ANSIBLE_HOME="${XDG_DATA_HOME}/ansible"

# docker
export DOCKER_CONFIG="${XDG_CONFIG_HOME}/docker"

# dotnet
export DOTNET_CLI_HOME="${XDG_DATA_HOME}/dotnet"

# gnupg
export GNUPGHOME="${XDG_DATA_HOME}/gnupg"
GPG_TTY="${TTY}" && export GPG_TTY

# go
export GOPATH="${XDG_DATA_HOME}/go"

# goku
export GOKU_EDN_CONFIG_FILE="${XDG_CONFIG_HOME}/karabiner/karabiner.edn"

# Google Cloud CLI
# GCloud Creds
export GCP_PROJECT_CREDENTIALS_PATH="${XDG_CONFIG_HOME}/gcloud/credentials"

# java
## Setup SDKMAN for Java
export SDKMAN_DIR="$(brew --prefix sdkman-cli)/libexec"
# This is for something else...
export _JAVA_OPTIONS=-Djava.util.prefs.userRoot="${XDG_CONFIG_HOME}/java"

# keepassxc
export KP_DB="{{ .keepassxcDatabase }}"

# less
export LESSHISTFILE="${XDG_STATE_HOME}/lesshst"

# node
export NODE_REPL_HISTORY="${XDG_STATE_HOME}/node/repl_history"

# npm
export NPM_CONFIG_CACHE="${XDG_CACHE_HOME}/npm"

# python
# Not really needed anymore post v3.13.0a3
export PYTHONSTARTUP="${XDG_CONFIG_HOME}/python/pythonrc"
# All that's required for Python 3.13+
export PYTHON_HISTORY="${XDG_STATE_HOME}/python_history"

# ruff
export RUFF_CACHE_DIR="${XDG_CACHE_HOME}/ruff"

# vim
# Commenting out to prioritize neovim
# export VIMINIT='let $MYVIMRC="$XDG_CONFIG_HOME/vim/vimrc" | source $MYVIMRC'
# export VIMDOTDIR="$XDG_CONFIG_HOME/vim"

# zsh
HISTSIZE=5000
HISTFILE="$XDG_STATE_HOME/zsh/history"
SAVEHIST="${HISTSIZE}"
HISTDUP=erase
# Directory for storing zinit and plugins
ZINIT_HOME="${XDG_DATA_HOME}/zinit/zinit.git"



###############
# ZSH OPTIONS #
###############
setopt APPENDHISTORY
setopt SHAREHISTORY
setopt HIST_IGNORE_SPACE
setopt HIST_IGNORE_ALL_DUPS
setopt HIST_SAVE_NO_DUPS
setopt HIST_IGNORE_DUPS
unsetopt BEEP

# zinit and plugins setup
# Install zinit if needed
if [ ! -d "${ZINIT_HOME}" ]; then
    mkdir -p "$(dirname $ZINIT_HOME)"
    git clone https://github.com/zdharma-continuum/zinit.git "${ZINIT_HOME}"
fi

source "${ZINIT_HOME}/zinit.zsh"

if [[ "$AGENT_FRIENDLY_PROMPT" = false ]]; then
  # Add powerlevel10k prompt
  zinit ice depth=1; zinit light romkatv/powerlevel10k
fi

# Add additional plugins
# Autosuggestions
zinit light zsh-users/zsh-autosuggestions
# Syntax highlighting
zinit light zsh-users/zsh-syntax-highlighting
# Completions
zinit light zsh-users/zsh-completions
# Make sure zsh can find completions from homebrew
if command -v brew &>/dev/null; then
    FPATH="$(brew --prefix)/share/zsh-completions:$FPATH"
fi
autoload -Uz compinit
compinit -d "${XDG_CACHE_HOME}/zsh/zcompdump-${ZSH_VERSION}"
compinit

# Should be below compinit
zinit cdreplay -q

# fzf tab completions
zinit light Aloxaf/fzf-tab

# Keybindings
# vi mode
bindkey -v

# Completion styling
zstyle ':completion:*' matcher-list 'm:{a-z}={A-Za-z}'
zstyle ':completion:*' list-colors "${(s.:.)LSCOLORS}"
zstyle ':completion:*' menu no
zstyle ':fzf-tab:complete:cd:*' fzf-preview 'ls --color $realpath'
zstyle ':fzf-tab:complete:__zoxide_z:*' fzf-preview 'ls --color $realpath'

###########
# Aliases #
###########
source "${XDG_CONFIG_HOME}/aliases/aliases"

######################################################
# Shell integrations and application initializations #
######################################################

# fzf
[ "$(command -v fzf)" ] && eval "$(fzf --zsh)"
# for vimrc: set rtp+=/opt/homebrew/opt/fzf

# homebrew
[ "$(command -v brew)" ] && eval "$("$(brew --prefix)"/bin/brew shellenv)"

{{ if eq .chezmoi.os "darwin" -}}
# iterm2
[ -e "${XDG_CONFIG_HOME}/iterm2/iterm2_shell_integration.zsh" ] && source "${XDG_CONFIG_HOME}/iterm2/iterm2_shell_integration.zsh"
{{- end -}}

# Google Cloud CLI
## Update PATH for the gcloud SDK
if [[ -f "$(brew --prefix)/share/google-cloud-sdk/path.zsh.inc" ]]; then
  source "$(brew --prefix)/share/google-cloud-sdk/path.zsh.inc"
fi
## If you want to use the autocomplete features:
if [[ -f "$(brew --prefix)/share/google-cloud-sdk/completion.zsh.inc" ]]; then
  source "$(brew --prefix)/share/google-cloud-sdk/completion.zsh.inc"
fi

{{ if .work -}}
# SDKMAN for Java
[[ -s "${SDKMAN_DIR}/bin/sdkman-init.sh" ]] && source "${SDKMAN_DIR}/bin/sdkman-init.sh"
{{- end -}}


# zoxide
[ "$(command -v zoxide)" ] && eval "$(zoxide init --cmd cd zsh)"

# atuin
# atuin allows these flags: "--disable-up-arrow" and/or "--disable-ctrl-r"
ATUIN_INIT_FLAGS=(--disable-up-arrow --disable-ctrl-r)
[ "$(command -v atuin)" ] && eval "$(atuin init zsh "${ATUIN_INIT_FLAGS[@]}")"

if [[ "$AGENT_FRIENDLY_PROMPT" = false ]]; then
  # To customize prompt, run `p10k configure` or edit ~/.config/zsh/.p10k.zsh.
  [[ ! -f "${XDG_CONFIG_HOME}/zsh/.p10k.zsh" ]] || source "${XDG_CONFIG_HOME}/zsh/.p10k.zsh"
fi